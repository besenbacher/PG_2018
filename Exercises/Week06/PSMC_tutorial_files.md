# Inferring historical populations sizes using PSMC

This exercise is inspired by a [similar exercise](https://informatics.fas.harvard.edu/psmc-journal-club-walkthrough.html) by Tim Sackton at Harward. 

The Pairwise Sequentially Markovian Coalescent (PSMC) model uses information in the complete diploid sequence of a single individual to infer the history of population size changes. The method was published in 2011 ([Li and Durbin 2011]()) the paper that we will discuss in class. It has become a very popular tool in the world of genomics. In this tutorial, we first walk through the steps to generate the necessary input data for PSMC. Then we run PSMC on chromosome 2 of an individual from the Simons Diversity Panel and plot the results.

For additional detail on how to run PSMC see the [GitHub page](https://github.com/lh3/psmc) for PSMC source code.

The bam files and reference genome necessary to run the following scripts can be found at: `/home/Data'.

To produce the input for PSMC we cannot just use the base calls or VCF files we already produced. PSMC requires a special format  produced by applying a consensus calling approach in base calling. So we start from the BAM files and map the reads to the reference genome to make base calls.

## Calling consensus sequence
Starting from mapped reads, the first step is to produce a consensus sequence in FASTQ format. To do this, we will use the samtools/bcftools suite. The basic idea behind generating a consensus sequence is to first use `samtools mpileup` to take the mapped reads and produce a VCF file. The consensus sequence is then generated by `bcftools` with the original consensus calling model, and converted to FASTQ (with some additional filtering) by `vcfutils.pl` A few notes:

We'll take advantage of Unix pipes and the ability of samtools to work with streaming input and output to run the whole pipeline (samtools -> bcftools -> vcfutils.pl) as one command. We run our consensus calling pipeline, consisting of a linked set of `samtools`, `bcftools`, and `vcfutils.pl` commands:

    samtools mpileup -Q 30 -q 30 -u -v -f /home/Data/Homo_sapiens.GRCh37.75.dna.chromosome.2.fa -r 2 ERR1025630_sort_dedup.bam |  bcftools call -c | vcfutils.pl vcf2fq -d 5 -D 34 -Q 30 > ERR1025630_sort_dedup_consensus.fq

    samtools mpileup -Q 30 -q 30 -u -v -f /home/Data/Homo_sapiens.GRCh37.75.dna.chromosome.2.fa -r 2 ../Data/Resulted_BAM_files/ERR1019039_chr2_piece_dedup.bam |  bcftools call -c | vcfutils.pl vcf2fq -d 5 -D 34 -Q 30 > ERR1019039_chr2_piece_dedup.fq

This takes as input an aligned bam file and a reference genome, generates an mpileup using `samtools`, calls the consensus sequence with `bcftools`, and then filters and converts the consensus to FASTQ format, writing the results for each chromosome to a separate FASTQ file. Some parameter explanations:

1. `samtools`:
    - `-Q` and `-q` in mpileup determine the cutoffs for baseQ and mapQ, respectively
    - `-v` tells mpileup to produce vcf output, and `-u` says that should be uncompressed
    - `-f` is the reference fasta used (needs to be indexed)
    - `-r` is the region to call the mpileup for (in this case, a particular chromosome based on the array task id)
    - `P964.bam` is the bam file to use
2. `bcftools`:
    - call `-c` calls a consensus sequence from the mpileup using the original calling method
3. `vcfutils.pl`:
    - `-d 5` and `-d 34` determine the minimum and maximum coverage to allow for `vcf2fq`, anything outside that range is filtered
    - `-Q 30` sets the root mean squared mapping quality minimum to 30

## Running PSMC
PSMC takes the consensus FASTQ file, and infers the history of population sizes. So first we need to convert this FASTQ file to the input format for PSMC:

    utils/fq2psmcfa -q20 ERR1025630_sort_dedup_consensus.fq > ERR1025630_sort_dedup_consensus.psmcfa

> The `-p` option specifies that there are 64 atomic time intervals and 28 (=1+25+1+1) free interval parameters. The first parameter spans the first 4 atomic time intervals, each of the next 25 parameters spans 2 intervals, the 27th spans 4 intervals and the last parameter spans the last 6 time intervals. The `-p` and `-t` options are manually chosen such that after 20 rounds of iterations, at least ~10 recombinations are inferred to occur in the intervals each parameter spans. Impropriate settings may lead to overfitting. The command line in the example above has been shown to be suitable for modern humans. 

    psmc -N25 -t15 -r5 -p "4+25*2+4+6" -o ERR1025630_sort_dedup_consensus.psmc ERR1025630_sort_dedup_consensus.psmcfa

Finally, we make the PSMC plot, using the per-generation mutation rate `-u` and the generation time in years `-g` reported in the paper. Because the paper does not give exact parameters for how they produced the plot, this likely will look a bit different than the figure, but hopefully it will be pretty close.

    psmc_plot.pl -u 1.2e-08 -g 25 -p ERR1025630_sort_dedup_consensus_plot ERR1025630_sort_dedup_consensus.psmc


## A note on scaling the PSMC output (from the PSMC GitHub page)

The PSMC output is scaled to the 2N_0. There are two ways of rescaling the time and the population size more meaningfully.

Firstly, suppose we know the per-site per-generation mutation rate $\mu$, we can compute $N_0$ as:

$$N_0 = \theta_0 / (4\mu) / s$$

where $\theta_0$ is given at the 2nd column of "TR" lines, and s is the bin size we use for generating the PSMC input. Knowing $N_0$, we can scale time to generations and relative population size to effective size by

  $$T_k = 2N_0 * t_k$$
  $$N_k = N_0 * \lambda_k$$

where $t_k$ and $\lambda_k$ are given at the 3rd and 4th columns of "RS" lines, respectively.

A problem with the above strategy is that we do not know a definite answer of $\mu$ and in fact it various with regions and mutation types. An alternative way is to use per-site pairwise sequence divergence to represent time:

  $$d_k = 2\mu * T_k = t_k * \theta_0 / s$$

and use scaled mutation rate to represent population size:

  $$\theta_k = 4N_k * \mu = \lambda_k * \theta_0 / s$$

where, again, $t_k$ and $\lambda_k$ are given at the "RS" line, $\theta_0$ at the "TR" line and s is the bin size, which defaults to 100 in fq2psmcfa.
